<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NYLA GENERAL SUPPLIES LTD — Projects Dashboard</title>
  <meta name="description" content="Live budget vs actuals dashboard for NYLA General Supplies Ltd projects" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#0ea5a4;--accent-2:#0ea5ff;--glass:rgba(255,255,255,0.03);
      --success:#16a34a;--danger:#ef4444;--gold:#f59e0b
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#071132 0%,#071b2a 100%);color:#e6eef8;margin:0;padding:28px}
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    header p{margin:0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:20px}

    /* left panel */
    .sidebar{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
    .project-item{padding:10px;border-radius:8px;margin-bottom:8px;cursor:pointer;background:var(--glass);display:flex;align-items:center;justify-content:space-between}
    .project-item.active{outline:2px solid rgba(14,165,164,0.12);box-shadow:0 6px 20px rgba(14,165,164,0.06)}
    .project-name{font-weight:700}
    .small{font-size:12px;color:var(--muted)}

    .controls{display:flex;gap:8px;margin-top:12px}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#021124;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    /* main area */
    .main{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:18px;min-height:600px}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .kpi{display:flex;gap:14px;align-items:center}
    .kpi .tile{background:var(--glass);padding:10px;border-radius:10px;text-align:center;min-width:160px}
    .tile .label{font-size:12px;color:var(--muted)}
    .tile .value{font-weight:800;font-size:16px}

    .category-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px}
    .category{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .cat-name{font-weight:700;font-size:13px}
    .cat-amount{font-weight:800;margin-top:6px}
    .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:6px;margin-top:8px;overflow:hidden}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--gold));width:0%}

    /* expense table */
    .exp-header{display:flex;align-items:center;justify-content:space-between;margin-top:18px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;text-align:left;font-size:13px}
    thead th{color:var(--muted);font-weight:700;font-size:12px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    tbody tr:nth-child(even){background:transparent}
    .amount{font-weight:700}

    .form-row{display:flex;gap:8px;margin-top:10px}
    .input,textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:8px;border-radius:8px;color:var(--muted);width:100%}
    textarea{min-height:56px}

    footer{color:var(--muted);font-size:13px;margin-top:18px}

    /* responsive */
    @media (max-width:980px){.grid{grid-template-columns:1fr;}.category-grid{grid-template-columns:repeat(2,1fr)}.sidebar{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>NYLA GENERAL SUPPLIES LTD — Projects Dashboard</h1>
        <p>Live budget vs actuals. Edit spending per category, add expense items — totals update instantly.</p>
      </div>
      <div>
        <button class="btn" id="exportCsv">Export CSV</button>
        <button class="btn ghost" id="resetDemo">Reset Demo Data</button>
      </div>
    </header>

    <div class="grid">
      <aside class="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Organization</div>
            <div style="font-weight:800">NYLA General Supplies Ltd</div>
          </div>
          <div class="small">Net data (local)</div>
        </div>

        <div style="margin-top:12px">
          <div id="projectList"></div>
        </div>

        <div class="controls">
          <button class="btn" id="addExpenseBtn">Add Expense</button>
          <button class="btn ghost" id="syncNote">Sync: Local</button>
        </div>

        <div style="margin-top:14px;color:var(--muted);font-size:13px">
          <div><strong>Legend</strong></div>
          <div style="margin-top:6px">Facilitation Fee = upfront cut</div>
          <div>Contractor fee includes 5% retention (held)</div>
        </div>
      </aside>

      <main class="main">
        <div class="header-row">
          <div class="kpi">
            <div class="tile">
              <div class="label">Project</div>
              <div class="value" id="projectTitle">YEDHI PRIMARY</div>
            </div>
            <div class="tile">
              <div class="label">Contract Value</div>
              <div class="value" id="contractValue">KSh 1,029,000</div>
            </div>
            <div class="tile">
              <div class="label">Net Available</div>
              <div class="value" id="netAvailable">KSh 524,790</div>
            </div>
          </div>

          <div style="min-width:260px;text-align:right">
            <div class="small">Total Spent</div>
            <div style="font-weight:800;font-size:18px" id="totalSpent">KSh 0</div>
            <div class="small" style="margin-top:6px" id="remainingText">Remaining: KSh 524,790</div>
          </div>
        </div>

        <div class="category-grid" id="categoriesGrid"></div>

        <div class="exp-header">
          <h3 style="margin:0">Expense ledger</h3>
          <div class="small">Add item: describe cost, choose category, enter amount and save.</div>
        </div>

        <table id="ledger">
          <thead>
            <tr><th>Date</th><th>Category</th><th>Description</th><th>Unit</th><th class="amount">Amount (KSh)</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
          <div style="width:240px">
            <select id="filterUnit" class="input">
              <option value="all">All units</option>
              <option value="unit1">Unit 1</option>
              <option value="unit2">Unit 2</option>
            </select>
          </div>
          <div style="flex:1"></div>
        </div>

        <div style="margin-top:18px;display:flex;gap:18px;align-items:stretch">
          <div style="flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:10px">
            <canvas id="doughnutChart" height="180"></canvas>
          </div>

          <div style="width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:10px">
            <div style="font-weight:700">Quick summary</div>
            <div style="margin-top:8px;color:var(--muted)" id="quickSummary">Loading...</div>
          </div>
        </div>

        <footer>
          Dashboard prototype — data stored locally (browser). For shared live updates use a small API (Google Sheets, Firebase, or a JSON file in a GitHub repo). I can help wire that up.
        </footer>
      </main>
    </div>
  </div>

  <!-- modal for adding expense -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;padding:18px">
    <div style="background:#021124;border-radius:10px;padding:18px;width:720px;max-width:100%">
      <h3 style="margin:0 0 8px">Add Expense</h3>
      <div style="color:var(--muted);font-size:13px;margin-bottom:12px">Enter details for this cost — it will update category totals immediately.</div>
      <div class="form-row">
        <input id="expDate" class="input" type="date" />
        <select id="expCategory" class="input"></select>
      </div>
      <div class="form-row" style="margin-top:8px">
        <input id="expUnit" class="input" placeholder="Unit (Unit1/Unit2)" />
        <input id="expAmount" class="input" placeholder="Amount KSh" type="number" />
      </div>
      <div style="margin-top:8px">
        <input id="expDesc" class="input" placeholder="Short description (e.g. Engineer professional advice)" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="closeModal">Cancel</button>
        <button class="btn" id="saveExp">Save Expense</button>
      </div>
    </div>
  </div>

  <script>
    // DEMO DATA MODEL (from earlier JSON) - kept in localStorage for persistence per browser
    const defaultData = {
      projects: [
        {
          id: 'yedhi', name: 'YEDHI PRIMARY', type: '2-door', contract_value: 1029000,
          deductions: {pmc:51450, tax:195510, facilitation_fee:102900, contractor_fee:154350, retention:7717.5},
          net_available:524790,
          units:[{id:'unit1',name:'Unit 1'},{id:'unit2',name:'Unit 2'}]
        },
        {
          id: 'sogorosa', name: 'SOGOROSA PRIMARY', type: '2-door', contract_value: 1029000,
          deductions: {pmc:51450, tax:195510, facilitation_fee:102900, contractor_fee:154350, retention:7717.5},
          net_available:524790, units:[{id:'unit1',name:'Unit 1'},{id:'unit2',name:'Unit 2'}]
        },
        {
          id: 'sosoni', name: 'SOSONI PRIMARY', type: '3-door', contract_value: 1546000,
          deductions: {pmc:77300, tax:293740, facilitation_fee:154600, contractor_fee:231900, retention:11595},
          net_available:788460, units:[{id:'unit1',name:'Unit 1'},{id:'unit2',name:'Unit 2'}]
        },
        {
          id: 'mugumoni', name: 'MUGUMONI PRIMARY', type: '3-door', contract_value: 1546000,
          deductions: {pmc:77300, tax:293740, facilitation_fee:154600, contractor_fee:231900, retention:11595},
          net_available:788460, units:[{id:'unit1',name:'Unit 1'},{id:'unit2',name:'Unit 2'}]
        }
      ],
      // categories and default % allocations (used to calculate budgeted amounts)
      categories: [
        {key:'excavation', name:'Excavation & Earthworks', pct:12},
        {key:'concrete', name:'Concrete Works', pct:18},
        {key:'steel', name:'Reinforcement / Steel', pct:5},
        {key:'pitwall', name:'Pit Walling', pct:20},
        {key:'superwall', name:'Superstructure Walling', pct:10},
        {key:'roofing', name:'Roofing', pct:12},
        {key:'doors', name:'Doors / Carpentry', pct:5},
        {key:'plaster', name:'Plastering & Screeding', pct:6},
        {key:'painting', name:'Painting', pct:3},
        {key:'vent', name:'Ventilation & Fittings', pct:2},
        {key:'transport', name:'Transport / Logistics', pct:5},
        {key:'misc', name:'Misc & Contingency', pct:2}
      ],
      // ledger entries: {projectId, unit, date, category, description, amount}
      ledger: []
    };

    // persistence helpers
    function load(){
      const raw = localStorage.getItem('nyla_dashboard');
      if(!raw) { localStorage.setItem('nyla_dashboard', JSON.stringify(defaultData)); return defaultData }
      try{ return JSON.parse(raw) }catch(e){ localStorage.setItem('nyla_dashboard', JSON.stringify(defaultData)); return defaultData }
    }
    function save(data){ localStorage.setItem('nyla_dashboard', JSON.stringify(data)); }

    let state = load();
    let activeProjectId = state.projects[0].id;

    // Build sidebar project list
    function renderProjects(){
      const container = document.getElementById('projectList'); container.innerHTML='';
      state.projects.forEach(p=>{
        const div = document.createElement('div'); div.className='project-item' + (p.id===activeProjectId? ' active':'');
        div.onclick = ()=>{ activeProjectId=p.id; renderAll() };
        div.innerHTML = `<div><div class="project-name">${p.name}</div><div class="small">${p.type} — KSh ${numberFormat(p.contract_value)}</div></div><div class="small">Net KSh ${numberFormat(p.net_available)}</div>`;
        container.appendChild(div);
      })
    }

    function numberFormat(n){ return (Math.round(n)).toLocaleString('en-KE') }

    // categories grid
    function renderCategories(){
      const grid = document.getElementById('categoriesGrid'); grid.innerHTML='';
      const project = state.projects.find(x=>x.id===activeProjectId);
      const net = project.net_available;
      state.categories.forEach(cat=>{
        const budget = Math.round(net * (cat.pct/100));
        const spent = state.ledger.filter(e=> e.projectId===project.id && e.category===cat.key).reduce((s,e)=>s+Number(e.amount||0),0);
        const pct = Math.min(100, Math.round((spent/budget)*100)||0);
        const div = document.createElement('div'); div.className='category';
        div.innerHTML = `<div class="cat-name">${cat.name}</div><div class="cat-amount">KSh ${numberFormat(budget)}</div><div class="small">Spent: KSh ${numberFormat(spent)}</div><div class="progress" data-key="${cat.key}"><span style="width:${pct}%"></span></div>`;
        grid.appendChild(div);
      })
    }

    function renderLedger(){
      const tbody = document.querySelector('#ledger tbody'); tbody.innerHTML='';
      const project = state.projects.find(x=>x.id===activeProjectId);
      const rows = state.ledger.filter(e=> e.projectId===project.id);
      rows.sort((a,b)=> new Date(b.date)-new Date(a.date));
      rows.forEach((r,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${labelFor(r.category)}</td><td>${escapeHtml(r.description||'')}</td><td>${r.unit||''}</td><td class="amount">${numberFormat(r.amount)}</td><td><button class="btn ghost" onclick="deleteEntry(${idx})">Del</button></td>`;
        tbody.appendChild(tr);
      })
    }

    window.deleteEntry = function(idx){
      // idx is index in filtered list - find matching entry
      const project = state.projects.find(x=>x.id===activeProjectId);
      const rows = state.ledger.filter(e=> e.projectId===project.id);
      const target = rows[idx];
      const globalIndex = state.ledger.indexOf(target);
      if(globalIndex>-1){ state.ledger.splice(globalIndex,1); save(state); renderAll() }
    }

    function labelFor(key){ const cat = state.categories.find(c=>c.key===key); return cat?cat.name:key }
    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    function renderHeader(){
      const p = state.projects.find(x=>x.id===activeProjectId);
      document.getElementById('projectTitle').textContent = p.name;
      document.getElementById('contractValue').textContent = 'KSh ' + numberFormat(p.contract_value);
      document.getElementById('netAvailable').textContent = 'KSh ' + numberFormat(p.net_available);
      const spent = state.ledger.filter(e=> e.projectId===p.id).reduce((s,e)=>s+Number(e.amount||0),0);
      document.getElementById('totalSpent').textContent = 'KSh ' + numberFormat(spent);
      const rem = p.net_available - spent;
      document.getElementById('remainingText').textContent = 'Remaining: KSh ' + numberFormat(rem);
    }

    // Doughnut chart
    let chart;
    function renderChart(){
      const p = state.projects.find(x=>x.id===activeProjectId);
      const labels = state.categories.map(c=>c.name);
      const budgetData = state.categories.map(c=> Math.round(p.net_available * (c.pct/100)) );
      const spentData = state.categories.map(c=> state.ledger.filter(e=> e.projectId===p.id && e.category===c.key).reduce((s,e)=>s+Number(e.amount||0),0));
      const ctx = document.getElementById('doughnutChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx,{type:'doughnut',data:{labels, datasets:[{label:'Budget',data:budgetData,backgroundColor:labels.map((_,i)=> i%2? 'rgba(14,165,164,0.9)':'rgba(14,165,255,0.9)' ),hoverOffset:6},{label:'Spent',data:spentData, backgroundColor:labels.map(()=> 'rgba(245,158,11,0.9)'),hoverOffset:6}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#c8d7ef'}}},maintainAspectRatio:false}})
    }

    // quick summary
    function renderQuick(){
      const p = state.projects.find(x=>x.id===activeProjectId);
      const spent = state.ledger.filter(e=> e.projectId===p.id).reduce((s,e)=>s+Number(e.amount||0),0);
      const pct = Math.round((spent / p.net_available)*100)||0;
      document.getElementById('quickSummary').innerHTML = `Spent: <strong>KSh ${numberFormat(spent)}</strong><br>Used: <strong>${pct}%</strong> of net available.`;
    }

    function renderLedgerAndUI(){ renderHeader(); renderCategories(); renderLedger(); renderChart(); renderQuick(); renderProjects(); }
    function renderAll(){ renderProjects(); renderHeader(); renderCategories(); renderLedger(); renderChart(); renderQuick(); populateCategorySelect(); }

    // modal logic
    document.getElementById('addExpenseBtn').addEventListener('click',()=>{ document.getElementById('modal').style.display='flex'; document.getElementById('expDate').valueAsDate=new Date(); populateCategorySelect() })
    document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none' })
    document.getElementById('saveExp').addEventListener('click', ()=>{
      const date = document.getElementById('expDate').value;
      const category = document.getElementById('expCategory').value;
      const amount = Number(document.getElementById('expAmount').value || 0);
      const desc = document.getElementById('expDesc').value;
      const unit = document.getElementById('expUnit').value || '';
      if(!date || !category || !amount) return alert('Please enter date, category and amount');
      state.ledger.push({projectId:activeProjectId, date, category, amount, description:desc, unit}); save(state); document.getElementById('modal').style.display='none'; renderAll();
    })

    function populateCategorySelect(){ const sel = document.getElementById('expCategory'); sel.innerHTML=''; state.categories.forEach(c=>{ const o=document.createElement('option');o.value=c.key;o.textContent=c.name;sel.appendChild(o) }) }

    // delete example with index in filtered list handled earlier

    // export CSV
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const p = state.projects.find(x=>x.id===activeProjectId);
      const rows = state.ledger.filter(e=>e.projectId===p.id);
      let csv = 'date,category,description,unit,amount
';
      rows.forEach(r=> csv += `${r.date},"${labelFor(r.category)}","${r.description}",${r.unit||''},${r.amount}
`);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `${p.id}_ledger.csv`; a.click(); URL.revokeObjectURL(url);
    })

    // reset demo
    document.getElementById('resetDemo').addEventListener('click', ()=>{ if(confirm('Reset demo data?')){ localStorage.removeItem('nyla_dashboard'); state = load(); renderAll() } })

    // init
    renderAll();

  </script>
</body>
</html>
