<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NYLA Pit Latrines - Live Progress Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
<style>
  :root {
    --primary: #00d4ff;
    --success: #28a745;
    --warning: #ffc107;
    --orange: #ff6b35;
    --purple: #9b59b6;
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  body {margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:#333;min-height:100vh;}
  .container {max-width:1400px;margin:20px auto;padding:20px;}
  header {text-align:center;padding:30px;background:rgba(255,255,255,0.97);border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.3);margin-bottom:30px;}
  h1 {margin:0;font-size:36px;background:linear-gradient(90deg,#00d4ff,#ff6b35);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .grid {display:grid;grid-template-columns:320px 1fr;gap:25px;}
  .sidebar {background:rgba(255,255,255,0.97);border-radius:20px;padding:25px;box-shadow:0 15px 40px rgba(0,0,0,0.2);}
  .project-card {background:white;padding:20px;border-radius:15px;margin-bottom:15px;cursor:pointer;transition:0.3s;box-shadow:0 8px 25px rgba(0,0,0,0.1);border:3px solid transparent;}
  .project-card:hover {transform:translateY(-8px);}
  .project-card.active {border-color:#00d4ff;background:#f0fbff;}
  .main {background:rgba(255,255,255,0.97);border-radius:20px;padding:30px;box-shadow:0 15px 40px rgba(0,0,0,0.2);}
  .header-bar {display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px;}
  .btn {background:#00d4ff;color:white;padding:12px 28px;border:none;border-radius:50px;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(0,212,255,0.4);transition:0.3s;}
  .btn:hover {background:#00b0d4;transform:translateY(-4px);}
  .btn-success {background:#28a745;}
  .kpi-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin:30px 0;}
  .kpi {background:white;padding:22px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.1);}
  .kpi-value {font-size:26px;font-weight:800;color:#2c3e50;}
  .visual-progress {text-align:center;margin:40px 0;background:white;padding:35px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
  .latrine-svg {width:100%;max-width:500px;margin:20px auto;}
  .category-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:20px;margin:40px 0;}
  .category {background:white;padding:22px;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.1);}
  .progress-container {height:24px;background:#eee;border-radius:12px;overflow:hidden;margin:15px 0;}
  .progress-bar {height:100%;width:0;transition:width 0.8s ease;background:linear-gradient(90deg,#00d4ff,#ff6b35);}
  .ledger {margin-top:40px;background:white;border-radius:15px;overflow:hidden;box-shadow:0 15px 40px rgba(0,0,0,0.2);}
  th {background:#00d4ff;color:white;padding:18px;text-align:left;}
  td {padding:14px;border-bottom:1px solid #eee;}
  .modal {position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-box {background:white;padding:35px;border-radius:20px;width:90%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,0.5);}
  .input, select {width:100%;padding:14px;margin:12px 0;border-radius:12px;border:2px solid #ddd;font-size:16px;}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>NYLA PIT LATRINES</h1>
    <p style="font-size:20px;color:#555;margin:10px 0 0;">Live Budget & Construction Tracker</p>
  </header>

  <div class="grid">
    <div class="sidebar">
      <h2 style="color:#2c3e50;margin-top:0;">Projects</h2>
      <div id="projectsList"></div>
    </div>

    <div class="main">
      <div class="header-bar">
        <div>
          <h2 id="projectTitle" style="margin:0;color:#2c3e50;">Select a project</h2>
          <p id="unitDisplay" style="margin:5px 0 0;color:#7f8c8d;font-size:16px;"></p>
        </div>
        <div>
          <button class="btn" id="addExpense">+ Add Expense</button>
          <button class="btn btn-success" id="downloadCSV" style="margin-left:10px;">Download CSV</button>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">Net Available</div><div class="kpi-value" id="net">KSh 0</div></div>
        <div class="kpi"><div class="kpi-label">Total Spent</div><div class="kpi-value" id="spent">KSh 0</div></div>
        <div class="kpi"><div class="kpi-label">Remaining</div><div class="kpi-value" id="remaining">KSh 0</div></div>
        <div class="kpi"><div class="kpi-label">% Complete</div><div class="kpi-value" id="percent">0%</div></div>
      </div>

      <div class="visual-progress">
        <h3>Pit Latrine Progress Visualization</h3>
        <svg class="latrine-svg" viewBox="0 0 400 600" id="latrineDiagram">
          <rect x="0" y="450" width="400" height="150" fill="#8b4513"/>
          <rect x="0" y="430" width="400" height="20" fill="#228B22"/>
          <rect x="100" y="450" width="200" height="200" fill="#4a2c0d" id="pit"/>
          <rect x="80" y="420" width="240" height="30" fill="#666" id="foundation"/>
          <rect x="100" y="300" width="200" height="120" fill="#95a5a6" id="walls"/>
          <polygon points="50,300 200,200 350,300" fill="#e74c3c" id="roof"/>
          <rect x="180" y="220" width="40" height="80" fill="#34495e" id="door"/>
          <text x="200" y="500" text-anchor="middle" fill="white" font-size="22" font-weight="bold">PIT</text>
          <text x="200" y="370" text-anchor="middle" fill="#333" font-size="20">WALLS</text>
          <text x="200" y="250" text-anchor="middle" fill="white" font-size="20">ROOF</text>
        </svg>
        <p id="progressText" style="font-size:20px;font-weight:600;color:#2c3e50;margin-top:20px;">Starting excavation...</p>
      </div>

      <h3 style="color:#2c3e50;">Budget vs Actual (Itemized)</h3>
      <div class="category-grid" id="categories"></div>

      <div class="ledger">
        <h3 style="margin:0;padding:20px;background:#00d4ff;color:white;border-radius:15px 15px 0 0;">Expense Ledger</h3>
        <table><thead>
          <tr><th>Date</th><th>Category</th><th>Description</th><th>Unit</th><th>Amount</th></tr>
        </thead><tbody id="ledger"></tbody></table>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h2 style="margin-top:0;">Add Expense</h2>
    <select id="expCategory" class="input"><option value="">Select Category</option></select>
    <input type="date" id="expDate" class="input" />
    <input type="text" id="expUnit" class="input" placeholder="Unit (unit1/unit2)" />
    <input type="text" id="expDesc" class="input" placeholder="Description" />
    <input type="number" id="expAmount" class="input" placeholder="Amount (KSh)" step="1" />
    <button class="btn" id="saveExpense" style="width:100%;margin-top:20px;">Save Expense</button>
  </div>
</div>

<script>
// ========== INDEXEDDB PERSISTENT STORAGE ==========
const db = new Dexie("NylaLatrineDB");
db.version(1).stores({ expenses: "++id,project,unit,date,category,desc,amount" });

// ========== DATA ==========
const PROJECTS = [
  {id:"yedhi",name:"YEDHI PRIMARY (2-door)",net:524790},
  {id:"sogorosa",name:"SOGOROSA PRIMARY (2-door)",net:524790},
  {id:"sosoni",name:"SOSONI PRIMARY (3-door)",net:788460},
  {id:"mugumoni",name:"MUGUMONI PRIMARY (3-door)",net:788460}
];

const CATEGORIES = [
  {key:"excavation",name:"Excavation & Earthworks",pct:12},
  {key:"concrete",name:"Concrete Works",pct:18},
  {key:"steel",name:"Reinforcement Steel",pct:5},
  {key:"pitwall",name:"Pit Walling",pct:20},
  {key:"superwall",name:"Superstructure Walling",pct:10},
  {key:"roofing",name:"Roofing",pct:12},
  {key:"doors",name:"Doors & Carpentry",pct:5},
  {key:"plaster",name:"Plaster & Screed",pct:6},
  {key:"painting",name:"Painting",pct:3},
  {key:"vent",name:"Ventilation",pct:2},
  {key:"transport",name:"Transport",pct:5},
  {key:"misc",name:"Miscellaneous",pct:2}
];

// ========== PRELIMINARY SPENT (YOUR REAL DATA) ==========
const PRELIMINARY_EXPENSES = [
  // YEDHI
  {project:"yedhi",date:"2025-10-15",category:"excavation",desc:"Site clearing & digging",amount:62975,unit:"both"},
  {project:"yedhi",date:"2025-10-20",category:"concrete",desc:"Foundation concrete",amount:45000,unit:"both"},
  {project:"yedhi",date:"2025-11-01",category:"pitwall",desc:"Pit walling materials",amount:80000,unit:"both"},
  // Add more as needed...
];

let activeProject = null;
let activeUnit = null;

function format(num) { return 'KSh ' + Number(num||0).toLocaleString(); }

// Load preliminary data once
async function loadPreliminary() {
  const count = await db.expenses.where({project: PRELIMINARY_EXPENSES[0]?.project || "yedhi"}).count();
  if (count === 0) {
    await db.expenses.bulkAdd(PRELIMINARY_EXPENSES);
  }
}
loadPreliminary();

// ========== RENDER FUNCTIONS ==========
async function renderAll() {
  renderSidebar();
  renderHeader();
  await renderKPIs();
  renderCategories();
  renderLedger();
  updateVisualProgress();
}

async function getExpenses() {
  let query = db.expenses.where({project: activeProject});
  if (activeUnit) query = query.and(e => e.unit === activeUnit || e.unit === "both" || !e.unit);
  return await query.toArray();
}

function renderSidebar() {
  const list = document.getElementById('projectsList');
  list.innerHTML = '';
  PROJECTS.forEach(p => {
    const card = document.createElement('div');
    card.className = 'project-card' + (activeProject===p.id?' active':'');
    card.innerHTML = `<div style="font-weight:800;font-size:17px;color:#2c3e50;">${p.name}</div>
      <div style="font-size:14px;margin-top:8px;color:#7f8c8d;">Net Available: ${format(p.net)}</div>`;
    card.onclick = () => { activeProject = p.id; activeUnit = null; renderAll(); };

    const units = document.createElement('div');
    units.style.marginTop = '15px'; units.style.display = activeProject===p.id ? 'block' : 'none';
    ['unit1','unit2'].forEach(u => {
      const btn = document.createElement('span');
      btn.textContent = u.toUpperCase();
      btn.style.padding = '8px 16px'; btn.style.background = activeUnit===u?'#00d4ff':'#eee';
      btn.style.color = activeUnit===u?'white':'#333'; btn.style.borderRadius = '50px';
      btn.style.marginRight = '10px'; btn.style.fontSize = '12px'; btn.style.cursor = 'pointer';
      btn.onclick = (e) => { e.stopPropagation(); activeUnit = u; renderAll(); };
      units.appendChild(btn);
    });
    card.appendChild(units);
    list.appendChild(card);
  });
}

async function renderKPIs() {
  if (!activeProject) return;
  const proj = PROJECTS.find(p => p.id === activeProject);
  const expenses = await getExpenses();
  const spent = expenses.reduce((a,e) => a + e.amount, 0);
  const pct = Math.round((spent / proj.net) * 100);

  document.getElementById('net').textContent = format(proj.net);
  document.getElementById('spent').textContent = format(spent);
  document.getElementById('remaining').textContent = format(proj.net - spent);
  document.getElementById('percent').textContent = pct + '%';
}

function renderCategories() {
  const container = document.getElementById('categories');
  container.innerHTML = '';
  if (!activeProject) return;

  (async () => {
    const proj = PROJECTS.find(p => p.id === activeProject);
    const expenses = await getExpenses();

    CATEGORIES.forEach(cat => {
      const budget = Math.round(proj.net * cat.pct / 100);
      const spent = expenses.filter(e => e.category === cat.key).reduce((a,e) => a + e.amount, 0);
      const pct = budget > 0 ? Math.round((spent / budget) * 100) : 0;

      const div = document.createElement('div');
      div.className = 'category';
      div.innerHTML = `
        <div style="font-weight:700;font-size:17px;color:#2c3e50;">${cat.name}</div>
        <div style="display:flex;justify-content:space-between;margin:10px 0;font-size:15px;">
          <span>Budget: ${format(budget)}</span>
          <span style="color:${pct>100?'#e74c3c':pct>80?'#e67e22':'#27ae60'}">Spent: ${format(spent)}</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" style="width:${pct}%"></div>
        </div>
        <div style="text-align:right;font-weight:600;color:${pct>100?'#e74c3c':'#2c3e50'}">${pct}% used</div>
      `;
      container.appendChild(div);
    });
  })();
}

async function renderLedger() {
  const tbody = document.getElementById('ledger');
  tbody.innerHTML = '';
  const rows = await getExpenses();
  rows.sort((a,b) => b.date.localeCompare(a.date)).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${CATEGORIES.find(c=>c.key===r.category)?.name}</td><td>${r.desc||'-'}</td><td>${r.unit||'Both'}</td><td>${format(r.amount)}</td>`;
    tbody.appendChild(tr);
  });
}

function updateVisualProgress() {
  if (!activeProject) return;
  (async () => {
    const proj = PROJECTS.find(p => p.id === activeProject);
    const expenses = await getExpenses();
    const totalSpent = expenses.reduce((a,e) => a + e.amount, 0);
    const pct = (totalSpent / proj.net) * 100;

    const excavation = expenses.filter(e => e.category === "excavation").reduce((a,e) => a + e.amount, 0) / (proj.net * 0.12);
    const walls = expenses.filter(e => e.category === "pitwall").reduce((a,e) => a + e.amount, 0) / (proj.net * 0.20);
    const roof = expenses.filter(e => e.category === "roofing").reduce((a,e) => a + e.amount, 0) / (proj.net * 0.12);

    document.getElementById('pit').style.opacity = excavation > 0.3 ? 1 : 0.3;
    document.getElementById('walls').style.opacity = walls > 0.4 ? 1 : 0.3;
    document.getElementById('roof').style.opacity = roof > 0.5 ? 1 : 0.3;
    document.getElementById('door').style.opacity = pct > 85 ? 1 : 0.3;

    document.getElementById('progressText').textContent = 
      pct < 20 ? "Excavation in progress" :
      pct < 50 ? "Walls rising!" :
      pct < 80 ? "Roofing underway" :
      pct < 95 ? "Finishing touches" : "Ready for handover!";
  })();
}

// ========== CSV DOWNLOAD ==========
document.getElementById('downloadCSV').onclick = async () => {
  if (!activeProject) return alert("Select a project first");
  const expenses = await getExpenses();
  let csv = "Date,Category,Description,Unit,Amount\n";
  expenses.forEach(e => {
    csv += `${e.date},${CATEGORIES.find(c=>c.key===e.category)?.name || e.category},${e.desc || ''},${e.unit || 'Both'},${e.amount}\n`;
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${activeProject}_expenses_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
};

// ========== MODAL & SAVE ==========
document.getElementById('addExpense').onclick = () => {
  if (!activeProject) return alert("Select project first!");
  const sel = document.getElementById('expCategory');
  sel.innerHTML = '<option value="">Choose Category</option>';
  CATEGORIES.forEach(c => sel.add(new Option(c.name, c.key)));
  document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('modal').style.display = 'flex';
};

document.getElementById('saveExpense').onclick = async () => {
  const amount = parseFloat(document.getElementById('expAmount').value);
  const cat = document.getElementById('expCategory').value;
  if (!cat || !amount) return alert("Fill all fields");
  
  await db.expenses.add({
    project: activeProject,
    unit: document.getElementById('expUnit').value.trim() || null,
    date: document.getElementById('expDate').value,
    category: cat,
    desc: document.getElementById('expDesc').value.trim(),
    amount: amount
  });
  document.getElementById('modal').style.display = 'none';
  renderAll();
};

document.querySelector('.modal').onclick = (e) => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };

renderAll();
</script>
</body>
</html>
